---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-config
  namespace: production
  labels:
    app: kibana
    component: elk
data:
  kibana.yml: |
    server.name: "kibana"
    server.host: "0.0.0.0"
    server.port: 5601
    server.publicBaseUrl: "https://kibana.openmeet.com"

    # Elasticsearch configuration
    elasticsearch.hosts: ["http://elasticsearch:9200"]
    elasticsearch.username: "elastic"
    elasticsearch.password: "${ELASTICSEARCH_PASSWORD}"
    elasticsearch.requestTimeout: 90000
    elasticsearch.pingTimeout: 30000

    # Security
    xpack.security.enabled: true
    xpack.security.encryptionKey: "${KIBANA_ENCRYPTION_KEY}"
    xpack.security.session.idleTimeout: "1h"
    xpack.security.session.lifespan: "8h"

    # Monitoring
    monitoring.enabled: true
    monitoring.ui.enabled: true
    monitoring.kibana.collection.enabled: true

    # Alerting
    xpack.alerting.enabled: true
    xpack.actions.enabled: true

    # Machine Learning
    xpack.ml.enabled: true

    # Reporting
    xpack.reporting.enabled: true
    xpack.reporting.encryptionKey: "${KIBANA_REPORTING_KEY}"

    # Logging
    logging.dest: stdout
    logging.json: true
    logging.verbose: false

    # APM
    xpack.apm.enabled: true
    xpack.apm.ui.enabled: true

    # Fleet/Elastic Agent
    xpack.fleet.enabled: true

    # Saved Objects encryption
    xpack.encryptedSavedObjects.encryptionKey: "${KIBANA_SAVED_OBJECTS_KEY}"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
  namespace: production
  labels:
    app: kibana
    component: elk
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kibana
      component: elk
  template:
    metadata:
      labels:
        app: kibana
        component: elk
    spec:
      containers:
      - name: kibana
        image: docker.elastic.co/kibana/kibana:8.11.3
        ports:
        - containerPort: 5601
          name: http
          protocol: TCP
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "1000m"
            memory: "2Gi"
        env:
        - name: ELASTICSEARCH_HOSTS
          value: "http://elasticsearch:9200"
        - name: ELASTICSEARCH_USERNAME
          value: "elastic"
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-credentials
              key: password
        - name: KIBANA_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: kibana-credentials
              key: encryption-key
        - name: KIBANA_REPORTING_KEY
          valueFrom:
            secretKeyRef:
              name: kibana-credentials
              key: reporting-key
        - name: KIBANA_SAVED_OBJECTS_KEY
          valueFrom:
            secretKeyRef:
              name: kibana-credentials
              key: saved-objects-key
        - name: SERVER_NAME
          value: "kibana"
        - name: SERVER_HOST
          value: "0.0.0.0"
        - name: NODE_OPTIONS
          value: "--max-old-space-size=1536"
        volumeMounts:
        - name: config
          mountPath: /usr/share/kibana/config/kibana.yml
          subPath: kibana.yml
          readOnly: true
        livenessProbe:
          httpGet:
            path: /api/status
            port: 5601
          initialDelaySeconds: 120
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /api/status
            port: 5601
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 3
      volumes:
      - name: config
        configMap:
          name: kibana-config
      securityContext:
        fsGroup: 1000
        runAsUser: 1000

---
apiVersion: v1
kind: Secret
metadata:
  name: kibana-credentials
  namespace: production
type: Opaque
stringData:
  encryption-key: "a7e3c1f5b9d2e8f4a6c0b3d7e9f1a3c5b7d9e1f3a5c7b9d1e3f5a7c9b1d3e5f7"
  reporting-key: "b8f4d2g6c0e9f5b7d1f3a5c7b9d1e3f5a7c9b1d3e5f7a9c1b3d5e7f9a1c3b5d7"
  saved-objects-key: "c9g5e3h7d1f0a6c8e2f4a6c8b0d2e4f6a8c0b2d4e6f8a0c2b4d6e8f0a2c4b6d8"
