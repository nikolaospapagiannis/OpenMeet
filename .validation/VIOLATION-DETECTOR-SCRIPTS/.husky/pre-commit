#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# STRICT PRE-COMMIT VALIDATION
# This hook PREVENTS bad code from being committed

echo "ğŸ” Running strict pre-commit validation..."

# 1. Run TypeScript check
echo "ğŸ“˜ Checking TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Fix them before committing."
  exit 1
fi

# 2. Run linting
echo "ğŸ¨ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting errors found. Run 'npm run lint:fix' to auto-fix."
  exit 1
fi

# 3. Run strict validation
echo "ğŸš¨ Running strict code validation..."
node scripts/validation/strict-validator.js
if [ $? -ne 0 ]; then
  echo "âŒ Code validation failed. Fix the issues above."
  exit 1
fi

# 4. Check for forbidden patterns
echo "ğŸ” Checking for forbidden patterns..."
FORBIDDEN_PATTERNS=(
  "console\.(log|error|warn)"
  "//\s*(TODO|FIXME|HACK)"
  "\bany\b"
  "localhost:3000"
  "localhost:8080"
  "password.*=.*['\"]"
  "api[Kk]ey.*=.*['\"]"
  "secret.*=.*['\"]"
)

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
  git diff --cached --name-only | xargs grep -l "$pattern" 2>/dev/null
  if [ $? -eq 0 ]; then
    echo "âŒ Forbidden pattern found: $pattern"
    echo "   Check the files listed above."
    exit 1
  fi
done

# 5. Check file sizes
echo "ğŸ“ Checking file sizes..."
git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    lines=$(wc -l < "$file")
    if [ $lines -gt 300 ]; then
      echo "âŒ File too large: $file ($lines lines > 300 max)"
      exit 1
    fi
  fi
done

# 6. Run tests for changed files
echo "ğŸ§ª Running tests..."
npm run test:changed
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Fix them before committing."
  exit 1
fi

# 7. Check test coverage
echo "ğŸ“Š Checking test coverage..."
npm run test:coverage -- --silent
COVERAGE=$(npm run test:coverage -- --silent | grep "All files" | awk '{print $4}' | sed 's/%//')
if [ "$COVERAGE" -lt 80 ]; then
  echo "âŒ Test coverage too low: ${COVERAGE}% < 80% required"
  exit 1
fi

# 8. Security check
echo "ğŸ”’ Running security audit..."
npm audit --production --audit-level=high
if [ $? -ne 0 ]; then
  echo "âŒ Security vulnerabilities found. Run 'npm audit fix'"
  exit 1
fi

# 9. Check for duplicate code
echo "ğŸ” Checking for duplicate code..."
npx jscpd src --min-lines 5 --reporters console --silent
if [ $? -ne 0 ]; then
  echo "âŒ Duplicate code detected. Extract common functionality."
  exit 1
fi

# 10. Validate commit message
echo "ğŸ“ Validating commit message..."
commit_regex='^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .{1,50}'
commit_msg=$(git log -1 --pretty=%B)
if ! [[ $commit_msg =~ $commit_regex ]]; then
  echo "âŒ Invalid commit message format."
  echo "   Format: <type>(<scope>): <subject>"
  echo "   Example: feat(auth): add user registration"
  echo "   Types: feat, fix, docs, style, refactor, test, chore"
  exit 1
fi

echo "âœ… All pre-commit checks passed!"