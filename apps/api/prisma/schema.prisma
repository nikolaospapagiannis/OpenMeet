// Nebula AI - Prisma Schema
// PostgreSQL Database Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  user
  admin
  super_admin
}

// System-level roles for platform administration (Super Admin Dashboard)
enum SystemRole {
  super_admin
  platform_admin
  support_admin
  billing_admin
  viewer
}

// Organization status for Super Admin management
enum OrgStatus {
  active
  suspended
  pending
  cancelled
}

// Organization tier for subscription management
enum OrgTier {
  free
  starter
  professional
  enterprise
  custom
}

// Subscription status for billing
enum SubStatus {
  trialing
  active
  past_due
  cancelled
  unpaid
  paused
}

enum SubscriptionTier {
  free
  pro
  business
  enterprise
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
}

enum MeetingStatus {
  scheduled
  in_progress
  completed
  cancelled
  failed
  processing
}

enum RecordingSource {
  bot
  extension
  upload
  api
  mobile
}

enum IntegrationType {
  zoom
  teams
  google
  google_meet
  outlook
  meet
  webex
  slack
  salesforce
  hubspot
  google_calendar
  asana
  jira
  linear
}

// Organizations
model Organization {
  id                    String             @id @default(uuid())
  name                  String
  slug                  String             @unique
  domain                String?
  logoUrl               String?
  logo                  String?
  subscriptionTier      SubscriptionTier   @default(free)
  subscriptionStatus    SubscriptionStatus @default(active)
  subscriptionExpiresAt DateTime?
  stripeCustomerId      String?            @unique
  stripeSubscriptionId  String?            @unique
  settings              Json               @default("{}")
  metadata              Json               @default("{}")
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Super Admin Dashboard fields
  status          OrgStatus @default(active)
  tier            OrgTier   @default(free)
  quotas          Json      @default("{}")
  features        Json      @default("{}")
  healthScore     Float     @default(100)
  suspendedAt     DateTime?
  suspendedReason String?

  users               User[]
  workspaces          Workspace[]
  meetings            Meeting[]
  integrations        Integration[]
  webhooks            Webhook[]
  apiKeys             OrgApiKey[]
  auditLogs           AuditLog[]
  usageMetrics        UsageMetric[]
  meetingTemplates    MeetingTemplate[]
  conversationThreads ConversationThread[]
  followUpConfigs     FollowUpConfig[]
  scheduleSuggestions ScheduleSuggestion[]
  automationRules     AutomationRule[]
  deals               Deal[]
  winLosses           WinLoss[]
  scorecards          Scorecard[]
  customVocabulary    CustomVocabulary[]
  aiModels            AIModel[]
  ssoConfig           SSOConfig?
  emailTemplates      EmailTemplate[]
  emailLogs           EmailLog[]
  teamInvites         TeamInvite[]
  subscription        Subscription?
  sessionGeoData      SessionGeoData[]

  @@index([slug])
  @@index([status])
  @@index([tier])
  @@index([healthScore])
}

// Team Invitations
model TeamInvite {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           UserRole     @default(user)
  token          String       @unique
  invitedById    String
  invitedBy      User         @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  status         String       @default("pending") // pending, accepted, expired, revoked
  expiresAt      DateTime
  acceptedAt     DateTime?
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, status])
  @@index([email])
  @@index([token])
}

// Users
model User {
  id              String        @id @default(uuid())
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email           String        @unique
  emailVerified   Boolean       @default(false)
  passwordHash    String?
  firstName       String?
  lastName        String?
  avatarUrl       String?
  role            UserRole      @default(user)
  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?
  mfaEnabled      Boolean       @default(false)
  mfaSecret       String?
  mfaBackupCodes  String[]      @default([])
  oauthProvider   String?
  oauthProviderId String?
  preferences     Json          @default("{}")
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Super Admin Dashboard fields
  systemRole   SystemRole?
  loginCount   Int         @default(0)
  isMfaEnabled Boolean     @default(false)

  sessions            Session[]
  meetings            Meeting[]
  comments            Comment[]
  soundbites          Soundbite[]
  apiKeys             ApiKey[]
  auditLogs           AuditLog[]
  workspaceMembers    WorkspaceMember[]
  createdWorkspaces   Workspace[]          @relation("WorkspaceCreator")
  resolvedComments    Comment[]            @relation("CommentResolver")
  deals               Deal[]
  scorecards          Scorecard[]
  integrations        Integration[]
  userRoles           UserRoleAssignment[]
  resourcePermissions ResourcePermission[]
  ssoSessions         SSOSession[]
  scimUser            SCIMUser?
  teamInvites         TeamInvite[]

  @@index([organizationId])
  @@index([email])
  @@index([systemRole])
  @@index([lastLoginAt])
}

// Sessions for JWT refresh tokens
model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String   @unique
  deviceInfo   Json?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  geoData      SessionGeoData?

  @@index([userId])
  @@index([expiresAt])
}

// Session Geo Data - For geographic distribution analytics
model SessionGeoData {
  id             String       @id @default(uuid())
  sessionId      String       @unique
  session        Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // GeoIP data
  country        String
  countryCode    String       @db.Char(2)
  region         String?
  city           String?
  latitude       Float?
  longitude      Float?
  timezone       String?

  // Anonymized IP for GDPR compliance
  ipHash         String

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, countryCode])
  @@index([organizationId, createdAt])
  @@index([countryCode])
}

// Workspaces
model Workspace {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  isDefault      Boolean      @default(false)
  settings       Json         @default("{}")
  createdById    String?
  createdBy      User?        @relation("WorkspaceCreator", fields: [createdById], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  meetings Meeting[]
  members  WorkspaceMember[]

  @@index([organizationId])
}

// Workspace members
model WorkspaceMember {
  id          String    @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        String    @default("member")
  permissions Json      @default("{}")
  joinedAt    DateTime  @default(now())

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

// Meetings
model Meeting {
  id                 String           @id @default(uuid())
  organizationId     String
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workspaceId        String?
  workspace          Workspace?       @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  userId             String
  user               User             @relation(fields: [userId], references: [id])
  externalMeetingId  String?
  externalId         String? // Alias for external platform ID (Zoom, Teams, Google Meet)
  title              String
  description        String?
  location           String? // Meeting location or platform
  scheduledStartAt   DateTime?
  scheduledAt        DateTime? // Alias for scheduledStartAt
  scheduledEndAt     DateTime?
  actualStartAt      DateTime?
  actualEndAt        DateTime?
  duration           Int? // Duration in seconds (alias for durationSeconds)
  durationSeconds    Int?
  status             MeetingStatus    @default(scheduled)
  recordingSource    RecordingSource?
  meetingUrl         String?
  platform           String?
  hostEmail          String?
  participantCount   Int              @default(0)
  isRecurring        Boolean          @default(false)
  recurringMeetingId String?
  autoRecord         Boolean          @default(false)
  createdBy          String?
  metadata           Json             @default("{}")
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  participants      MeetingParticipant[]
  recordings        MeetingRecording[]
  transcripts       Transcript[]
  transcriptContent TranscriptContent[]
  summaries         MeetingSummary[]
  analytics         MeetingAnalytics[]
  comments          Comment[]
  soundbites        Soundbite[]
  dealMeetings      DealMeeting[]
  scorecards        Scorecard[]
  liveSessions      LiveSession[]
  videos            Video[]
  qualityScore      QualityScore?
  aiAnalyses        AIAnalysis[]
  calendarSyncs     CalendarSync[]
  hubspotSyncs      HubspotMeetingSync[]
  salesforceSyncs   SalesforceMeetingSync[]

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([scheduledStartAt])
}

// Meeting participants
model MeetingParticipant {
  id              String    @id @default(uuid())
  meetingId       String
  meeting         Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId          String?
  email           String?
  name            String?
  role            String    @default("participant")
  status          String    @default("accepted") // accepted, declined, tentative
  isOrganizer     Boolean   @default(false)
  joinedAt        DateTime?
  leftAt          DateTime?
  duration        Int       @default(0) // Duration in seconds (alias for talkTimeSeconds)
  talkTimeSeconds Int       @default(0)
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now())

  @@index([meetingId])
}

// Meeting recordings
model MeetingRecording {
  id                  String   @id @default(uuid())
  meetingId           String
  meeting             Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  fileUrl             String
  fileSizeBytes       BigInt?
  durationSeconds     Int?
  format              String?
  quality             String?
  s3Key               String?
  transcriptionStatus String   @default("pending")
  isVideo             Boolean  @default(false)
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  transcripts Transcript[]
  video       Video?

  @@index([meetingId])
}

// Transcripts (metadata only, content now in TranscriptContent)
model Transcript {
  id               String            @id @default(uuid())
  meetingId        String
  meeting          Meeting           @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  recordingId      String?
  recording        MeetingRecording? @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  mongodbId        String?           @unique // Deprecated - for backward compatibility
  language         String            @default("en")
  wordCount        Int?
  confidenceScore  Float?
  processingTimeMs Int?
  version          Int               @default(1)
  isFinal          Boolean           @default(false)
  metadata         Json              @default("{}")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  summaries MeetingSummary[]
  content   TranscriptContent?

  @@index([meetingId])
}

// Transcript Content (replacing MongoDB storage)
// Stores full transcript data with pgvector support for semantic search
model TranscriptContent {
  id             String     @id @default(uuid())
  transcriptId   String     @unique
  transcript     Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  meetingId      String
  meeting        Meeting    @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  organizationId String

  // Full transcript text
  fullText String @db.Text // Full transcript text for display and full-text search

  // Structured data
  segments Json // Array of transcript segments with timestamps, speakers, etc.
  speakers Json // Array of speaker info (speakerId, name, talkTime)

  // Metadata
  language     String @default("en")
  wordCount    Int    @default(0)
  duration     Int    @default(0) // Duration in seconds
  speakerCount Int    @default(0)

  // Vector embedding for semantic search (1536 dimensions for OpenAI ada-002)
  // Using Bytes for now as Prisma doesn't natively support vector type
  // Will be handled as vector(1536) in PostgreSQL with pgvector
  embedding        Bytes? // Vector embedding for semantic search
  embeddingModel   String? // Model used to generate embedding (e.g., "text-embedding-ada-002")
  embeddingVersion Int? // Version of the embedding for re-generation tracking

  // Additional metadata
  metadata Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note: The following indexes require raw SQL migration:
  // - GIN index for full-text search on fullText
  // - IVFFlat index for vector similarity search on embedding

  // Indexes for search performance
  // Note: Full-text search index will be added via migration (GIN index)
  // Note: Vector similarity index will be added via migration (IVFFlat index)
  @@index([transcriptId])
  @@index([meetingId])
  @@index([organizationId])
  @@index([language])
  @@index([createdAt])
}

// Meeting summaries
model MeetingSummary {
  id               String      @id @default(uuid())
  meetingId        String
  meeting          Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  transcriptId     String?
  transcript       Transcript? @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  summaryType      String      @default("general")
  title            String?
  overview         String?
  keyPoints        Json        @default("[]")
  actionItems      Json        @default("[]")
  decisions        Json        @default("[]")
  questions        Json        @default("[]")
  customSections   Json        @default("{}")
  aiModel          String?
  aiModelVersion   String?
  processingTimeMs Int?
  metadata         Json        @default("{}")
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([meetingId])
}

// Meeting analytics
model MeetingAnalytics {
  id                   String   @id @default(uuid())
  meetingId            String   @unique
  meeting              Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  talkTimeDistribution Json?
  sentimentScores      Json?
  engagementScore      Float?
  interruptionCount    Int      @default(0)
  questionCount        Int      @default(0)
  monologueCount       Int      @default(0)
  paceWpmAverage       Int?
  topics               Json     @default("[]")
  keywords             Json     @default("[]")
  metadata             Json     @default("{}")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([meetingId])
}

// Comments
model Comment {
  id               String    @id @default(uuid())
  meetingId        String
  meeting          Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId           String
  user             User      @relation(fields: [userId], references: [id])
  parentCommentId  String?
  parentComment    Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  timestampSeconds Int?
  content          String
  isResolved       Boolean   @default(false)
  resolvedById     String?
  resolvedBy       User?     @relation("CommentResolver", fields: [resolvedById], references: [id])
  resolvedAt       DateTime?
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  replies Comment[] @relation("CommentReplies")

  @@index([meetingId])
}

// Soundbites/Clips
model Soundbite {
  id                String   @id @default(uuid())
  meetingId         String
  meeting           Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  title             String?
  startTimeSeconds  Int
  endTimeSeconds    Int
  transcriptSegment String?
  shareToken        String?  @unique
  viewCount         Int      @default(0)
  isPublic          Boolean  @default(false)
  metadata          Json     @default("{}")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([meetingId])
}

// Integrations
model Integration {
  id             String          @id @default(uuid())
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?           @relation(fields: [userId], references: [id])
  type           IntegrationType
  name           String
  isActive       Boolean         @default(true)
  accessToken    String?
  refreshToken   String?
  expiresAt      DateTime?
  settings       Json            @default("{}")
  metadata       Json            @default("{}")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([organizationId])
}

// Webhooks
model Webhook {
  id              String       @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  url             String
  events          String[]
  isActive        Boolean      @default(true)
  secret          String?
  description     String?
  createdBy       String?
  lastTriggeredAt DateTime?
  failureCount    Int          @default(0)
  metadata        Json         @default("{}")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  logs            WebhookLog[]

  @@index([organizationId])
}

model WebhookLog {
  id           String   @id @default(uuid())
  webhookId    String
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event        String
  payload      Json
  statusCode   Int?
  responseTime Int      @default(0)
  success      Boolean
  error        String?
  attempt      Int      @default(1)
  timestamp    DateTime @default(now())

  @@index([webhookId])
  @@index([timestamp])
}

// API Keys (User-scoped, existing model)
model ApiKey {
  id             String    @id @default(uuid())
  organizationId String
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  name           String
  keyHash        String    @unique
  keyPrefix      String
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean   @default(true)
  permissions    Json      @default("{}")
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([keyPrefix])
}

// Organization API Keys (Super Admin Dashboard)
model OrgApiKey {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  keyHash        String       @unique
  keyPrefix      String
  scopes         Json         @default("[]")
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean      @default(true)
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([keyPrefix])
}

// Audit logs - Fortune 100 Compliance-Grade
enum AuditStatus {
  success
  failure
  pending
  error
}

model AuditLog {
  id             String        @id @default(uuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])
  userEmail      String? // Store email for audit trail even if user is deleted

  // Action details
  action       String // Action performed (login, create, update, delete, etc.)
  actionLabel  String? // Human-readable action label
  resourceType String?
  resourceId   String?
  status       AuditStatus @default(success)

  // Entity tracking (Super Admin Dashboard)
  entityType String?
  entityId   String?

  // Request details
  ipAddress      String?
  userAgent      String?
  method         String? // HTTP method
  endpoint       String? // API endpoint
  queryParams    Json?
  requestBody    Json? // Sanitized request body
  responseStatus Int?

  // Change tracking
  before  Json? // State before change
  after   Json? // State after change
  changes Json? // Specific changes made

  // Context
  sessionId      String?
  apiKeyId       String?
  impersonatedBy String? // If action was performed via impersonation

  // Security
  riskLevel      String    @default("low") // low, medium, high, critical
  requiresReview Boolean   @default(false)
  reviewedAt     DateTime?
  reviewedBy     String?

  // Metadata
  metadata     Json    @default("{}")
  duration     Int? // Request duration in ms
  errorMessage String?
  stackTrace   String?

  // Compliance
  isGdprRelevant  Boolean   @default(false)
  isHipaaRelevant Boolean   @default(false)
  isSoc2Relevant  Boolean   @default(false)
  retainUntil     DateTime? // For compliance retention

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([resourceId])
  @@index([status])
  @@index([createdAt])
  @@index([ipAddress])
  @@index([riskLevel])
  @@index([isGdprRelevant])
  @@index([isHipaaRelevant])
  @@index([isSoc2Relevant])
  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
  @@index([entityType])
  @@index([entityId])
}

// Usage metrics
model UsageMetric {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metricType     String
  metricValue    BigInt
  periodStart    DateTime
  periodEnd      DateTime
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([periodStart, periodEnd])
}

// Notifications
enum NotificationType {
  email
  sms
  push
  in_app
}

enum NotificationStatus {
  pending
  sent
  failed
  delivered
  read
}

model Notification {
  id            String             @id @default(uuid())
  userId        String?
  type          NotificationType
  status        NotificationStatus @default(pending)
  channel       String
  recipient     String
  subject       String?
  content       String
  metadata      Json               @default("{}")
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failureReason String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// Device Tokens for Push Notifications
model DeviceToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  platform   String // ios, android, web
  deviceId   String?
  appVersion String?
  isActive   Boolean  @default(true)
  lastUsedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([isActive])
}

// Workflow Automation Models

// Meeting Templates
enum TemplateType {
  one_on_one
  team_meeting
  client_call
  interview
  standup
  retrospective
  custom
}

model MeetingTemplate {
  id             String        @id @default(uuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  name           String
  description    String?
  type           TemplateType  @default(custom)
  category       String? // For categorization: sales, customer_success, internal, interview, project
  templateData   Json          @default("{}")
  variables      Json          @default("[]")
  isActive       Boolean       @default(true)
  isPreBuilt     Boolean       @default(false)
  usageCount     Int           @default(0)
  metadata       Json          @default("{}")
  tags           String[]      @default([])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([type])
  @@index([isPreBuilt])
  @@index([category])
}

// Conversation Threads
model ConversationThread {
  id                String       @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  title             String
  topic             String?
  participantEmails String[]
  meetingIds        String[]
  messageCount      Int          @default(0)
  lastActivityAt    DateTime     @default(now())
  isArchived        Boolean      @default(false)
  metadata          Json         @default("{}")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([organizationId])
  @@index([lastActivityAt])
}

// Automated Follow-ups Configuration
enum FollowUpTrigger {
  meeting_end
  action_item_created
  deadline_approaching
  meeting_scheduled
  custom
}

enum FollowUpAction {
  send_email
  send_sms
  create_calendar_event
  send_webhook
  create_task
}

model FollowUpConfig {
  id                String          @id @default(uuid())
  organizationId    String
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId            String?
  name              String
  description       String?
  trigger           FollowUpTrigger
  action            FollowUpAction
  triggerConditions Json            @default("{}")
  actionConfig      Json            @default("{}")
  delayMinutes      Int             @default(0)
  isActive          Boolean         @default(true)
  executionCount    Int             @default(0)
  lastExecutedAt    DateTime?
  metadata          Json            @default("{}")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  executions FollowUpExecution[]

  @@index([organizationId])
  @@index([trigger])
}

model FollowUpExecution {
  id           String         @id @default(uuid())
  configId     String
  config       FollowUpConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  meetingId    String?
  status       String         @default("pending")
  result       Json?
  errorMessage String?
  executedAt   DateTime?
  metadata     Json           @default("{}")
  createdAt    DateTime       @default(now())

  @@index([configId])
  @@index([meetingId])
  @@index([status])
}

// Smart Scheduling
model ScheduleSuggestion {
  id                String       @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId            String
  requestData       Json
  suggestions       Json         @default("[]")
  selectedSlotIndex Int?
  status            String       @default("pending")
  expiresAt         DateTime
  metadata          Json         @default("{}")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([expiresAt])
}

// Automation Rules Engine
enum RuleTrigger {
  meeting_created
  meeting_completed
  transcript_ready
  summary_generated
  participant_joined
  action_item_created
  keyword_detected
  sentiment_detected
  duration_exceeded
  scheduled
}

enum RuleConditionOperator {
  equals
  not_equals
  contains
  not_contains
  greater_than
  less_than
  in
  not_in
}

enum RuleActionType {
  send_email
  send_sms
  add_tag
  assign_to_user
  create_task
  trigger_webhook
  move_to_workspace
  create_calendar_event
  send_notification
}

model AutomationRule {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  name           String
  description    String?
  trigger        RuleTrigger
  conditions     Json         @default("[]")
  actions        Json         @default("[]")
  priority       Int          @default(50)
  isActive       Boolean      @default(true)
  executionCount Int          @default(0)
  lastExecutedAt DateTime?
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  executions RuleExecution[]

  @@index([organizationId])
  @@index([trigger])
  @@index([isActive])
}

model RuleExecution {
  id              String         @id @default(uuid())
  ruleId          String
  rule            AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  meetingId       String?
  triggeredBy     Json
  conditionsMet   Boolean
  actionsResults  Json           @default("[]")
  status          String         @default("completed")
  errorMessage    String?
  executionTimeMs Int?
  metadata        Json           @default("{}")
  createdAt       DateTime       @default(now())

  @@index([ruleId])
  @@index([meetingId])
  @@index([createdAt])
}

// Video Intelligence (GAP #3 - Otter competitor feature)
enum VideoProcessingStatus {
  pending
  processing
  completed
  failed
}

enum HighlightType {
  important_decision
  action_item
  question_answer
  key_moment
  screen_share
  custom
}

model Video {
  id                  String                @id @default(uuid())
  meetingId           String?
  meeting             Meeting?              @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  recordingId         String?               @unique
  recording           MeetingRecording?     @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  organizationId      String
  userId              String
  s3Key               String                @unique
  s3Bucket            String
  fileUrl             String
  thumbnailUrl        String?
  fileName            String
  fileSizeBytes       BigInt
  durationSeconds     Int?
  width               Int?
  height              Int?
  fps                 Int?
  codec               String?
  format              String?
  bitrate             BigInt?
  processingStatus    VideoProcessingStatus @default(pending)
  processingProgress  Int                   @default(0)
  processingError     String?
  audioExtracted      Boolean               @default(false)
  audioS3Key          String?
  thumbnailsGenerated Boolean               @default(false)
  thumbnailS3Keys     Json                  @default("[]")
  transcriptId        String?
  metadata            Json                  @default("{}")
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  clips        VideoClip[]
  highlights   VideoHighlight[]
  screenShares VideoScreenShare[]

  @@index([meetingId])
  @@index([organizationId])
  @@index([userId])
  @@index([processingStatus])
}

model VideoClip {
  id                String   @id @default(uuid())
  videoId           String?
  video             Video?   @relation(fields: [videoId], references: [id], onDelete: Cascade)
  meetingId         String?
  userId            String
  title             String?
  description       String?
  startTime         Float? // Alias for startTimeSeconds (in seconds)
  endTime           Float? // Alias for endTimeSeconds (in seconds)
  startTimeSeconds  Int
  endTimeSeconds    Int
  category          String? // action_item, decision, objection, insight, question, highlight
  keyPhrases        Json     @default("[]")
  participants      Json     @default("[]")
  sentiment         String? // positive, neutral, negative
  importance        Int      @default(0) // 0-100
  s3Key             String?  @unique
  fileUrl           String?
  thumbnailUrl      String?
  shareToken        String?  @unique
  isPublic          Boolean  @default(false)
  viewCount         Int      @default(0)
  downloadCount     Int      @default(0)
  transcriptSegment String?
  metadata          Json     @default("{}")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([videoId])
  @@index([meetingId])
  @@index([userId])
  @@index([shareToken])
  @@index([category])
}

model VideoHighlight {
  id               String        @id @default(uuid())
  videoId          String
  video            Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  highlightType    HighlightType
  title            String?
  description      String?
  startTimeSeconds Int
  endTimeSeconds   Int
  confidence       Float         @default(0.0)
  thumbnailUrl     String?
  transcriptText   String?
  aiDetected       Boolean       @default(false)
  aiModel          String?
  metadata         Json          @default("{}")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([videoId])
  @@index([highlightType])
  @@index([aiDetected])
}

model VideoScreenShare {
  id               String   @id @default(uuid())
  videoId          String
  video            Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  startTimeSeconds Int
  endTimeSeconds   Int
  thumbnailUrl     String?
  ocrText          String?
  contentType      String?
  confidence       Float    @default(0.0)
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([videoId])
}

// ============================================================================
// LIVE FEATURES - Real-time Transcription, Collaboration & AI Assistance
// ============================================================================

enum LiveSessionStatus {
  active
  paused
  completed
  failed
}

enum LiveBookmarkType {
  manual
  action_item
  decision
  question
  key_moment
}

// Live transcription sessions for real-time meetings
model LiveSession {
  id               String            @id @default(uuid())
  meetingId        String
  meeting          Meeting           @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  status           LiveSessionStatus @default(active)
  startedAt        DateTime          @default(now())
  endedAt          DateTime?
  language         String            @default("en")
  participantCount Int               @default(0)
  audioStreamUrl   String?
  websocketClients Json              @default("[]")
  metadata         Json              @default("{}")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  bookmarks          LiveBookmark[]
  transcriptSegments LiveTranscriptSegment[]
  insights           LiveInsight[]
  reactions          LiveReaction[]

  @@index([meetingId])
  @@index([status])
  @@index([startedAt])
}

// Real-time transcript segments (streaming)
model LiveTranscriptSegment {
  id            String      @id @default(uuid())
  liveSessionId String
  liveSession   LiveSession @relation(fields: [liveSessionId], references: [id], onDelete: Cascade)
  segmentIndex  Int
  text          String
  speaker       String?
  speakerId     String?
  startTime     Float
  endTime       Float
  confidence    Float       @default(0.0)
  isFinal       Boolean     @default(false)
  language      String?
  words         Json        @default("[]")
  createdAt     DateTime    @default(now())

  @@index([liveSessionId])
  @@index([startTime])
  @@index([isFinal])
}

// Live bookmarks and highlights during meetings
model LiveBookmark {
  id               String           @id @default(uuid())
  liveSessionId    String
  liveSession      LiveSession      @relation(fields: [liveSessionId], references: [id], onDelete: Cascade)
  meetingId        String
  userId           String?
  type             LiveBookmarkType @default(manual)
  title            String
  description      String?
  timestampSeconds Float
  autoDetected     Boolean          @default(false)
  tags             String[]
  metadata         Json             @default("{}")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([liveSessionId])
  @@index([meetingId])
  @@index([timestampSeconds])
  @@index([type])
}

// Live AI insights and alerts
model LiveInsight {
  id               String      @id @default(uuid())
  liveSessionId    String
  liveSession      LiveSession @relation(fields: [liveSessionId], references: [id], onDelete: Cascade)
  insightType      String // action_item, question, decision, tone_alert, speaking_time, keyword_alert
  content          String
  confidence       Float       @default(0.0)
  timestampSeconds Float
  speaker          String?
  metadata         Json        @default("{}")
  createdAt        DateTime    @default(now())

  @@index([liveSessionId])
  @@index([insightType])
  @@index([timestampSeconds])
}

// Live reactions and emoji during meetings
model LiveReaction {
  id               String      @id @default(uuid())
  liveSessionId    String
  liveSession      LiveSession @relation(fields: [liveSessionId], references: [id], onDelete: Cascade)
  userId           String?
  userName         String?
  emoji            String
  timestampSeconds Float
  createdAt        DateTime    @default(now())

  @@index([liveSessionId])
  @@index([timestampSeconds])
}

// ====================================
// Advanced AI Features (GAP #6)
// ====================================

// Custom Vocabulary and Acronyms
model CustomVocabulary {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  term           String
  expansion      String?
  definition     String?
  aliases        String[]     @default([])
  category       String? // industry_jargon, company_specific, acronym, technical
  industry       String?
  usage          String?
  isActive       Boolean      @default(true)
  usageCount     Int          @default(0)
  metadata       Json         @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, term])
  @@index([organizationId])
  @@index([category])
}

// Custom AI Models
enum AIModelStatus {
  training
  ready
  failed
  deprecated
}

enum AIModelType {
  categorization
  sentiment
  summary
  transcription
  custom
}

model AIModel {
  id                 String        @id @default(uuid())
  organizationId     String
  organization       Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name               String
  description        String?
  type               AIModelType
  status             AIModelStatus @default(training)
  baseModel          String // gpt-4, gpt-3.5-turbo, etc.
  fineTuneJobId      String? // OpenAI fine-tune job ID
  modelId            String? // Fine-tuned model ID
  trainingDataCount  Int           @default(0)
  accuracy           Float?
  precision          Float?
  recall             Float?
  f1Score            Float?
  promptTemplate     String?
  systemPrompt       String?
  customParameters   Json          @default("{}")
  performanceMetrics Json          @default("{}")
  metadata           Json          @default("{}")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  trainedAt          DateTime?
  lastUsedAt         DateTime?

  qualityScores QualityScore[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
}

// Meeting Quality Scores
model QualityScore {
  id                   String   @id @default(uuid())
  meetingId            String
  meeting              Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  organizationId       String
  userId               String?
  overallScore         Float // 0-100
  engagementScore      Float? // 0-100
  participationBalance Float? // 0-100
  timeManagementScore  Float? // 0-100
  objectiveCompletion  Float? // 0-100
  actionabilityScore   Float? // 0-100
  clarityScore         Float? // 0-100
  productivityScore    Float? // 0-100
  sentimentScore       Float? // -100 to 100
  aiModelId            String?
  aiModel              AIModel? @relation(fields: [aiModelId], references: [id])
  factors              Json     @default("{}")
  recommendations      Json     @default("[]")
  metadata             Json     @default("{}")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([meetingId])
  @@index([organizationId])
  @@index([userId])
  @@index([overallScore])
  @@index([createdAt])
}

// AI Analysis Results (for tracking)
enum AIAnalysisStatus {
  pending
  processing
  completed
  failed
}

model AIAnalysis {
  id                  String           @id @default(uuid())
  meetingId           String
  meeting             Meeting          @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  transcriptionId     String?
  organizationId      String
  status              AIAnalysisStatus @default(pending)
  analysisTypes       String[]
  summary             Json?
  keyPoints           Json?
  actionItems         Json?
  decisions           Json?
  questions           Json?
  sentiment           Json?
  topics              Json?
  risks               Json?
  opportunities       Json?
  followUps           Json?
  metrics             Json?
  competitiveInsights Json?
  metadata            Json             @default("{}")
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([meetingId])
  @@index([organizationId])
  @@index([status])
}

// ===========================
// Revenue Intelligence (GAP #2 - Gong Competitor)
// Premium feature: Deal tracking, Win-loss analysis, Sales coaching
// ===========================

enum DealStage {
  prospecting
  qualification
  proposal
  negotiation
  closed_won
  closed_lost
}

enum WinLossOutcome {
  won
  lost
}

enum CRMProvider {
  salesforce
  hubspot
  pipedrive
  custom
}

// Deal tracking
model Deal {
  id                String       @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name              String
  amount            Float?
  currency          String       @default("USD")
  stage             DealStage    @default(prospecting)
  probability       Int          @default(0)
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  crmProvider       CRMProvider?
  crmDealId         String?
  crmAccountId      String?
  contactEmail      String?
  contactName       String?
  ownerId           String?
  owner             User?        @relation(fields: [ownerId], references: [id])
  description       String?
  tags              Json         @default("[]")
  customFields      Json         @default("{}")
  metadata          Json         @default("{}")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  meetings   DealMeeting[]
  winLoss    WinLoss?
  scorecards Scorecard[]

  @@index([organizationId])
  @@index([stage])
  @@index([ownerId])
  @@index([crmProvider, crmDealId])
}

// Link meetings to deals
model DealMeeting {
  id        String   @id @default(uuid())
  dealId    String
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  meetingId String
  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  impact    String? // How this meeting impacted the deal
  createdAt DateTime @default(now())

  @@unique([dealId, meetingId])
  @@index([dealId])
  @@index([meetingId])
}

// Win-loss analysis
model WinLoss {
  id                  String         @id @default(uuid())
  dealId              String         @unique
  deal                Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  organizationId      String
  organization        Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  outcome             WinLossOutcome
  closedDate          DateTime
  dealAmount          Float?
  competitorName      String?
  lostReason          String?
  winReason           String?
  keyObjections       Json           @default("[]")
  sentimentAnalysis   Json?
  competitiveInsights Json?
  lessonsLearned      Json           @default("[]")
  aiGeneratedInsights String?
  metadata            Json           @default("{}")
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([organizationId])
  @@index([outcome])
  @@index([closedDate])
  @@index([competitorName])
}

// Sales coaching scorecards
model Scorecard {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meetingId      String
  meeting        Meeting      @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  dealId         String?
  deal           Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  userId         String
  user           User         @relation(fields: [userId], references: [id])

  // Talk metrics
  talkRatio        Float? // Rep vs prospect talk time ratio
  repTalkTime      Int? // Seconds
  prospectTalkTime Int? // Seconds

  // Question metrics
  questionCount Int    @default(0)
  questionRate  Float? // Questions per minute

  // Engagement metrics
  monologueCount    Int  @default(0)
  longestMonologue  Int? // Seconds
  interruptionCount Int  @default(0)

  // Speech metrics
  fillerWordCount Int  @default(0)
  fillerWords     Json @default("[]")
  paceWpm         Int? // Words per minute

  // Overall scores (0-100)
  overallScore    Int?
  engagementScore Int?
  listeningScore  Int?
  clarityScore    Int?

  // AI coaching insights
  coachingInsights Json @default("[]")
  strengths        Json @default("[]")
  improvements     Json @default("[]")

  aiAnalysisRaw Json?
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId])
  @@index([meetingId])
  @@index([userId])
  @@index([dealId])
  @@index([createdAt])
}

// ====================================================================
// Integration Sync Models
// ====================================================================

// Calendar Sync
model CalendarSync {
  id               String   @id @default(uuid())
  meetingId        String
  meeting          Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId           String
  calendarProvider String // google, outlook, etc.
  externalEventId  String
  calendarId       String?
  syncedAt         DateTime @default(now())
  lastSyncedAt     DateTime @updatedAt
  syncStatus       String   @default("synced") // synced, pending, failed
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([calendarProvider, externalEventId])
  @@index([meetingId])
  @@index([userId])
  @@map("calendar_sync")
}

// HubSpot Meeting Sync
model HubspotMeetingSync {
  id                  String   @id @default(uuid())
  meetingId           String
  meeting             Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  hubspotMeetingId    String   @unique
  hubspotEngagementId String?
  hubspotContactIds   Json     @default("[]")
  hubspotDealId       String?
  syncedAt            DateTime @default(now())
  lastSyncedAt        DateTime @updatedAt
  syncStatus          String   @default("synced")
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([meetingId])
  @@index([hubspotDealId])
  @@map("hubspot_meeting_sync")
}

// Salesforce Meeting Sync
model SalesforceMeetingSync {
  id                      String   @id @default(uuid())
  meetingId               String
  meeting                 Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  salesforceEventId       String   @unique
  salesforceAccountId     String?
  salesforceContactIds    Json     @default("[]")
  salesforceOpportunityId String?
  syncedAt                DateTime @default(now())
  lastSyncedAt            DateTime @updatedAt
  syncStatus              String   @default("synced")
  metadata                Json     @default("{}")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([meetingId])
  @@index([salesforceOpportunityId])
  @@map("salesforce_meeting_sync")
}

// Slack Workspace
model SlackWorkspace {
  id             String   @id @default(uuid())
  organizationId String
  teamId         String   @unique
  teamName       String
  accessToken    String
  botUserId      String?
  webhookUrl     String?
  isActive       Boolean  @default(true)
  settings       Json     @default("{}")
  metadata       Json     @default("{}")
  installedAt    DateTime @default(now())
  updatedAt      DateTime @updatedAt

  channels      SlackChannel[]
  notifications SlackNotificationSettings[]

  @@index([organizationId])
  @@index([teamId])
}

// Slack Channel
model SlackChannel {
  id          String         @id @default(uuid())
  workspaceId String
  workspace   SlackWorkspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  channelId   String
  channelName String
  isPrivate   Boolean        @default(false)
  isActive    Boolean        @default(true)
  metadata    Json           @default("{}")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([workspaceId, channelId])
  @@index([workspaceId])
}

// Slack Notification Settings
model SlackNotificationSettings {
  id                 String         @id @default(uuid())
  userId             String
  workspaceId        String
  workspace          SlackWorkspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  channelId          String?
  notifyOnStart      Boolean        @default(false)
  notifyOnEnd        Boolean        @default(true)
  notifyOnSummary    Boolean        @default(true)
  notifyOnActionItem Boolean        @default(true)
  metadata           Json           @default("{}")
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@map("slack_notification_settings")
}

// Teams Installation
model TeamsInstallation {
  id             String    @id @default(uuid())
  organizationId String
  tenantId       String
  teamId         String?
  teamName       String?
  serviceUrl     String?
  appId          String
  botId          String?
  accessToken    String?
  refreshToken   String?
  expiresAt      DateTime?
  isActive       Boolean   @default(true)
  settings       Json      @default("{}")
  metadata       Json      @default("{}")
  installedAt    DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([tenantId, teamId])
  @@index([organizationId])
  @@index([tenantId])
}

// ====================================================================
// Additional Feature Models
// ====================================================================

// Slide Capture
model Slide {
  id                 String   @id @default(uuid())
  meetingId          String
  slideNumber        Int
  timestamp          DateTime
  imageUrl           String
  thumbnailUrl       String
  extractedText      String   @default("")
  transcriptPosition Int      @default(0)
  isScreenShare      Boolean  @default(true)
  metadata           Json     @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([meetingId])
  @@index([slideNumber])
}

// Live Captions
model LiveCaption {
  id         String   @id @default(uuid())
  meetingId  String
  text       String
  speaker    String?
  confidence Float    @default(0.9)
  timestamp  DateTime
  isFinal    Boolean  @default(true)
  language   String?
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  @@index([meetingId])
  @@index([timestamp])
}

// Transcription (separate from Transcript for backwards compat)
model Transcription {
  id        String   @id @default(uuid())
  meetingId String
  text      String
  language  String   @default("en")
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([meetingId])
}

// Task Management
enum TaskStatus {
  open
  in_progress
  completed
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

model Task {
  id               String       @id
  title            String
  description      String?
  status           TaskStatus   @default(open)
  priority         TaskPriority @default(medium)
  dueDate          DateTime?
  assignedTo       String?
  organizationId   String
  createdBy        String
  sourceType       String?
  sourceId         String?
  externalSystem   String?
  externalId       String?
  externalSyncedAt DateTime?
  metadata         Json         @default("{}")
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([organizationId])
  @@index([assignedTo])
  @@index([status])
  @@index([sourceId])
  @@index([externalId])
}

// ====================================================================
// RBAC (Role-Based Access Control) Models
// ====================================================================

// Permissions - Define all available permissions in the system
model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "meetings.create", "transcripts.read"
  resource    String // e.g., "meetings", "transcripts", "analytics"
  action      String // e.g., "create", "read", "update", "delete", "export", "manage"
  description String?
  category    String? // e.g., "meetings", "content", "admin", "billing"
  isSystem    Boolean  @default(true) // System permissions cannot be deleted
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions     RolePermission[]
  resourcePermissions ResourcePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([category])
}

// Roles - Define roles that can be assigned to users
model Role {
  id             String   @id @default(uuid())
  organizationId String?
  name           String // e.g., "Owner", "Admin", "Member", "Guest"
  description    String?
  isSystem       Boolean  @default(false) // System roles (Owner, Admin, Member, Guest)
  isCustom       Boolean  @default(false) // User-created custom roles
  priority       Int      @default(50) // Higher priority roles override lower ones
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  permissions     RolePermission[]
  userAssignments UserRoleAssignment[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isSystem])
}

// RolePermission - Junction table linking roles to permissions
model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  granted      Boolean    @default(true) // true = grant, false = deny (for overrides)
  metadata     Json       @default("{}")
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// UserRoleAssignment - Assign roles to users
model UserRoleAssignment {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId         String
  role           Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  organizationId String?
  assignedBy     String? // User ID who assigned this role
  expiresAt      DateTime? // Optional role expiration
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, roleId, organizationId])
  @@index([userId])
  @@index([roleId])
  @@index([organizationId])
}

// ResourcePermission - Fine-grained resource-level permissions
model ResourcePermission {
  id             String     @id @default(uuid())
  userId         String
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId   String
  permission     Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  resourceType   String // e.g., "meeting", "transcript", "workspace"
  resourceId     String // The specific resource ID
  organizationId String?
  granted        Boolean    @default(true) // true = grant, false = deny
  metadata       Json       @default("{}")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([userId, permissionId, resourceType, resourceId])
  @@index([userId])
  @@index([permissionId])
  @@index([resourceType, resourceId])
  @@index([organizationId])
}

// ====================================================================
// Meeting Scheduler Models
// ====================================================================

// Scheduling Links (Calendly-like functionality)
model SchedulingLink {
  id                  String   @id @default(uuid())
  userId              String
  organizationId      String
  slug                String   @unique
  title               String
  description         String?
  duration            Int // Duration in minutes
  bufferTime          Int      @default(0) // Minutes before/after
  availability        Json     @default("{}") // AvailabilityRules
  customQuestions     Json?    @default("[]") // CustomQuestion[]
  confirmationMessage String?
  redirectUrl         String?
  isActive            Boolean  @default(true)
  bookingCount        Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  bookings Booking[]

  @@index([userId])
  @@index([organizationId])
  @@index([slug])
}

// Bookings
model Booking {
  id                String         @id @default(uuid())
  schedulingLinkId  String
  schedulingLink    SchedulingLink @relation(fields: [schedulingLinkId], references: [id], onDelete: Cascade)
  meetingId         String?
  attendeeName      String
  attendeeEmail     String
  attendeePhone     String?
  scheduledTime     DateTime
  timezone          String
  duration          Int // Duration in minutes
  status            String         @default("confirmed") // confirmed, cancelled, rescheduled, completed
  customAnswers     Json?          @default("{}")
  notes             String?
  confirmationToken String         @unique
  reminderSentAt    DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([schedulingLinkId])
  @@index([scheduledTime])
  @@index([status])
}

// ====================================================================
// Video Intelligence Models (Extended)
// ====================================================================

// Shared Video Clips
model SharedClip {
  id                String    @id @default(uuid())
  clipId            String
  userId            String
  includeTranscript Boolean   @default(false)
  includeNotes      Boolean   @default(false)
  expiresAt         DateTime?
  viewCount         Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([clipId])
  @@index([userId])
}

// ====================================================================
// Jira Integration Models
// ====================================================================

// Jira Workspace
model JiraWorkspace {
  id                String    @id @default(uuid())
  organizationId    String
  cloudId           String
  siteName          String
  siteUrl           String
  accessToken       String
  refreshToken      String?
  tokenExpiresAt    DateTime?
  defaultProjectKey String?
  defaultIssueType  String?
  isActive          Boolean   @default(true)
  installedBy       String
  installedAt       DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  issues JiraIssue[]

  @@index([organizationId])
  @@index([cloudId])
}

// Jira Issue
model JiraIssue {
  id           String        @id @default(uuid())
  meetingId    String
  workspaceId  String
  workspace    JiraWorkspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  issueKey     String
  issueSummary String
  issueUrl     String
  assignee     String?
  dueDate      String?
  metadata     Json          @default("{}")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([meetingId])
  @@index([workspaceId])
  @@index([issueKey])
}

// ====================================================================
// Asana Integration Models
// ====================================================================

// Asana Workspace
model AsanaWorkspace {
  id                String    @id @default(uuid())
  organizationId    String
  workspaceGid      String
  workspaceName     String
  accessToken       String
  refreshToken      String?
  tokenExpiresAt    DateTime?
  defaultProjectGid String?
  isActive          Boolean   @default(true)
  installedBy       String
  installedAt       DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  tasks AsanaTask[]

  @@index([organizationId])
  @@index([workspaceGid])
}

// Asana Task
model AsanaTask {
  id          String         @id @default(uuid())
  meetingId   String
  workspaceId String
  workspace   AsanaWorkspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  taskGid     String
  taskName    String
  taskUrl     String
  assignee    String?
  dueDate     String?
  metadata    Json           @default("{}")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([meetingId])
  @@index([workspaceId])
  @@index([taskGid])
}

// ====================================================================
// Rate Limiting & DDoS Protection Models
// ====================================================================

// IP Whitelist/Blacklist
enum IPListType {
  whitelist
  blacklist
}

model IPList {
  id             String     @id @default(uuid())
  ip             String
  type           IPListType
  reason         String?
  expiresAt      DateTime?
  permanent      Boolean    @default(false)
  createdBy      String?
  organizationId String?
  metadata       Json       @default("{}")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([ip, type])
  @@index([type])
  @@index([expiresAt])
  @@index([organizationId])
}

// IP Blocks (temporary and permanent)
model IPBlock {
  id             String    @id @default(uuid())
  ip             String
  reason         String
  blockedAt      DateTime  @default(now())
  expiresAt      DateTime?
  permanent      Boolean   @default(false)
  violationType  String? // e.g., 'rate_limit', 'ddos', 'credential_stuffing'
  violationCount Int       @default(1)
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([ip])
  @@index([expiresAt])
  @@index([violationType])
  @@index([permanent])
}

// Rate Limit Violations Log
model RateLimitViolation {
  id             String   @id @default(uuid())
  identifier     String // user ID, IP, or API key
  identifierType String // 'user', 'ip', 'apikey'
  endpoint       String?
  limitType      String // 'user', 'ip', 'endpoint', 'apikey'
  tier           String? // subscription tier
  violatedAt     DateTime @default(now())
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  @@index([identifier])
  @@index([identifierType])
  @@index([endpoint])
  @@index([violatedAt])
}

// DDoS Attack Events
enum AttackType {
  burst
  connection_flood
  pattern_attack
  slow_request
  scraper
  credential_stuffing
  unknown
}

model DDoSAttackEvent {
  id             String     @id @default(uuid())
  attackType     AttackType
  sourceIP       String
  targetEndpoint String?
  severity       String // 'low', 'medium', 'high', 'critical'
  blocked        Boolean    @default(false)
  requestCount   Int        @default(1)
  detectedAt     DateTime   @default(now())
  resolvedAt     DateTime?
  metadata       Json       @default("{}")
  createdAt      DateTime   @default(now())

  @@index([attackType])
  @@index([sourceIP])
  @@index([severity])
  @@index([detectedAt])
}

// Trust Scores
model TrustScore {
  id                  String   @id @default(uuid())
  identifier          String
  identifierType      String // 'user', 'ip', 'apikey'
  score               Int // 0-100
  level               String // 'very_low', 'low', 'medium', 'high', 'very_high'
  multiplier          Float // rate limit multiplier
  successfulRequests  Int      @default(0)
  failedRequests      Int      @default(0)
  rateLimitViolations Int      @default(0)
  lastCalculatedAt    DateTime @default(now())
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([identifier, identifierType])
  @@index([identifierType])
  @@index([score])
  @@index([level])
}

// Rate Limit Alerts
enum AlertSeverity {
  info
  warning
  critical
}

model RateLimitAlert {
  id             String        @id @default(uuid())
  alertType      String // 'rate_limit_spike', 'ddos_attack', 'blocked_ips_spike'
  severity       AlertSeverity
  message        String
  details        Json          @default("{}")
  acknowledged   Boolean       @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime      @default(now())

  @@index([alertType])
  @@index([severity])
  @@index([acknowledged])
  @@index([createdAt])
}

// ====================================================================
// ENTERPRISE SSO & SCIM PROVISIONING MODELS
// ====================================================================

enum SSOProvider {
  okta
  azure_ad
  auth0
  google_workspace
  onelogin
  ping_identity
  custom_saml
}

enum SCIMResourceType {
  User
  Group
}

enum SCIMOperationType {
  create
  update
  delete
  replace
}

// SSO Configuration per Organization
model SSOConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Provider Configuration
  provider   SSOProvider
  enabled    Boolean     @default(true)
  enforceSSO Boolean     @default(false) // Require SSO for all org users

  // SAML Configuration
  samlEntityId         String?
  samlSSOUrl           String? // Identity Provider SSO URL
  samlSLOUrl           String? // Single Logout URL
  samlCertificate      String? // X.509 certificate from IdP
  samlPrivateKey       String? // Our private key for signing
  samlSignRequests     Boolean @default(true)
  samlSignedAssertions Boolean @default(true)

  // Okta Specific
  oktaDomain       String?
  oktaClientId     String?
  oktaClientSecret String?
  oktaApiToken     String?

  // Auth0 Specific
  auth0Domain       String?
  auth0ClientId     String?
  auth0ClientSecret String?
  auth0Connection   String?

  // Domain-based SSO routing
  domains String[] @default([]) // Domains that should use this SSO

  // JIT Provisioning
  jitProvisioning     Boolean @default(true)
  jitRoleMapping      Json    @default("{}") // Map IdP roles to our roles
  jitAttributeMapping Json    @default("{}") // Map SAML attributes to user fields

  // SCIM Configuration
  scimEnabled  Boolean @default(false)
  scimEndpoint String? // Our SCIM endpoint for this org
  scimToken    String? @unique // Bearer token for SCIM requests
  scimVersion  String  @default("2.0")

  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions   SSOSession[]
  scimUsers  SCIMUser[]
  scimGroups SCIMGroup[]
  auditLogs  SSOAuditLog[]

  @@index([provider])
  @@index([scimToken])
}

// SSO Sessions (tracks active SSO logins)
model SSOSession {
  id          String    @id @default(uuid())
  ssoConfigId String
  ssoConfig   SSOConfig @relation(fields: [ssoConfigId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // SAML Session Info
  nameId       String // SAML NameID from assertion
  sessionIndex String // SAML SessionIndex

  // Session Management
  ipAddress      String?
  userAgent      String?
  startedAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  expiresAt      DateTime

  // Logout tracking
  loggedOutAt DateTime?
  logoutType  String? // user_initiated, idp_initiated, timeout, admin

  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  @@index([ssoConfigId])
  @@index([userId])
  @@index([expiresAt])
  @@index([nameId])
}

// SCIM Users (tracks users provisioned via SCIM)
model SCIMUser {
  id          String    @id @default(uuid())
  ssoConfigId String
  ssoConfig   SSOConfig @relation(fields: [ssoConfigId], references: [id], onDelete: Cascade)
  userId      String?   @unique
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // SCIM Resource Fields
  externalId String // ID from the IdP
  userName   String // Username from IdP
  active     Boolean @default(true)

  // Name
  givenName   String?
  familyName  String?
  middleName  String?
  displayName String?

  // Email & Phone
  emails       Json @default("[]") // Array of {value, type, primary}
  phoneNumbers Json @default("[]")

  // Groups
  groups Json @default("[]") // Array of group IDs

  // Metadata
  scimMeta Json @default("{}") // SCIM meta (resourceType, created, lastModified, version)
  rawData  Json @default("{}") // Full SCIM user object

  // Sync tracking
  lastSyncedAt DateTime @default(now())
  syncedFrom   String? // IP address of IdP

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ssoConfigId, externalId])
  @@index([ssoConfigId])
  @@index([userId])
  @@index([externalId])
  @@index([userName])
}

// SCIM Groups
model SCIMGroup {
  id          String    @id @default(uuid())
  ssoConfigId String
  ssoConfig   SSOConfig @relation(fields: [ssoConfigId], references: [id], onDelete: Cascade)

  // SCIM Resource Fields
  externalId  String // ID from the IdP
  displayName String

  // Members
  members Json @default("[]") // Array of {value, $ref, type}

  // Metadata
  scimMeta Json @default("{}")
  rawData  Json @default("{}")

  // Sync tracking
  lastSyncedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ssoConfigId, externalId])
  @@index([ssoConfigId])
  @@index([externalId])
  @@index([displayName])
}

// SSO Audit Logs (track all SSO/SCIM events)
model SSOAuditLog {
  id          String    @id @default(uuid())
  ssoConfigId String
  ssoConfig   SSOConfig @relation(fields: [ssoConfigId], references: [id], onDelete: Cascade)

  eventType    String // login_success, login_failed, logout, scim_create, scim_update, etc.
  resourceType SCIMResourceType?
  resourceId   String?

  userId String?
  email  String?

  // Request details
  ipAddress String?
  userAgent String?

  // Event data
  success      Boolean @default(true)
  errorMessage String?
  requestData  Json    @default("{}")
  responseData Json    @default("{}")

  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  @@index([ssoConfigId])
  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
}

// Certificate Store for SAML
model SAMLCertificate {
  id             String @id @default(uuid())
  organizationId String

  name        String
  certificate String // PEM-encoded certificate
  privateKey  String? // PEM-encoded private key (if we generated it)

  // Certificate details
  issuer       String?
  subject      String?
  validFrom    DateTime?
  validUntil   DateTime?
  fingerprint  String?
  serialNumber String?

  // Usage
  isActive Boolean @default(true)
  purpose  String  @default("signing") // signing, encryption

  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive])
}

// White-Label Configuration
model WhitelabelConfig {
  id             String @id @default(uuid())
  organizationId String @unique

  // Branding
  primaryColor    String @default("#3B82F6") // Default blue
  secondaryColor  String @default("#10B981") // Default green
  accentColor     String @default("#8B5CF6") // Default purple
  backgroundColor String @default("#FFFFFF") // Default white
  textColor       String @default("#1F2937") // Default dark gray

  // Logo & Assets
  logoUrl       String? // Main logo (light mode)
  logoDarkUrl   String? // Logo for dark mode
  logoSquareUrl String? // Square logo for icons
  faviconUrl    String? // Browser favicon

  // Custom Domain
  customDomain         String? @unique
  customDomainVerified Boolean @default(false)
  customDomainDNS      Json? // DNS records needed for verification

  // Email Branding
  emailFromName  String  @default("Nebula AI")
  emailFromEmail String?
  emailLogoUrl   String?
  emailFooter    String?

  // Custom CSS
  customCSS String? @db.Text
  customJS  String? @db.Text

  // Product Naming
  productName String  @default("Nebula AI")
  companyName String?
  tagline     String?

  // Features
  hideWatermark Boolean @default(false)
  customFonts   Json? // Font family configurations

  // Metadata
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customDomain])
  @@index([organizationId])
}

// ====================================================================
// EMAIL MANAGEMENT MODELS
// ====================================================================

// Email Template Types
enum EmailTemplateType {
  welcome
  email_verification
  password_reset
  meeting_invitation
  meeting_summary
  meeting_recording_ready
  subscription_confirmation
  subscription_renewal
  subscription_cancelled
  payment_receipt
  team_invitation
  weekly_digest
  quota_warning
  security_alert
  custom
}

// Email Delivery Status
enum EmailDeliveryStatus {
  pending
  sent
  delivered
  failed
  bounced
  opened
  clicked
  unsubscribed
  spam_reported
}

// Email Templates (Database Storage)
model EmailTemplate {
  id             String        @id @default(uuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Template Details
  name     String
  type     EmailTemplateType @default(custom)
  subject  String
  htmlBody String            @db.Text
  textBody String?           @db.Text

  // Template Variables (Handlebars format)
  variables Json @default("[]") // Array of {name, type, required, defaultValue}

  // Template Settings
  isDefault Boolean @default(false) // System default template
  isActive  Boolean @default(true)
  version   Int     @default(1)

  // Usage Tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Metadata
  metadata  Json     @default("{}")
  createdBy String?
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emailLogs EmailLog[]

  @@unique([organizationId, name, version])
  @@index([organizationId])
  @@index([type])
  @@index([isDefault])
  @@index([isActive])
}

// Email Logs (Database Logging)
model EmailLog {
  id             String        @id @default(uuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Email Details
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  to         String // Comma-separated for multiple recipients
  from       String
  cc         String?
  bcc        String?
  replyTo    String?
  subject    String

  // Delivery Information
  status    EmailDeliveryStatus @default(pending)
  messageId String?             @unique // SendGrid message ID

  // SendGrid Webhook Data
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  firstOpenedAt  DateTime?
  clickedAt      DateTime?
  bouncedAt      DateTime?
  unsubscribedAt DateTime?
  spamReportedAt DateTime?

  // Tracking Metrics
  openCount        Int @default(0)
  clickCount       Int @default(0)
  uniqueClickCount Int @default(0)

  // Error Information
  error      String? @db.Text
  errorCode  String?
  bounceType String? // hard, soft, blocked

  // Webhook Events
  webhookEvents Json @default("[]") // Array of all webhook events

  // Additional Data
  attachmentCount Int       @default(0)
  scheduledAt     DateTime?
  metadata        Json      @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([messageId])
  @@index([to])
  @@index([status])
  @@index([templateId])
  @@index([sentAt])
  @@index([createdAt])
}

// Email Template Variables (for complex templates)
model EmailTemplateVariable {
  id         String @id @default(uuid())
  templateId String

  // Variable Details
  name         String // Variable name in template {{name}}
  displayName  String? // Human-readable name
  type         String // string, number, boolean, date, array, object
  required     Boolean @default(false)
  defaultValue String?
  description  String?
  validation   Json? // Validation rules

  // Metadata
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, name])
  @@index([templateId])
}

// Email Webhook Events (for tracking SendGrid webhooks)
model EmailWebhookEvent {
  id         String  @id @default(uuid())
  emailLogId String?

  // Event Details
  event     String // processed, delivered, open, click, bounce, etc.
  messageId String?
  timestamp DateTime

  // Event Data
  email     String
  ipAddress String?
  userAgent String?
  url       String? // For click events
  category  String? // Custom category

  // Raw Event
  rawEvent Json

  createdAt DateTime @default(now())

  @@index([emailLogId])
  @@index([messageId])
  @@index([event])
  @@index([timestamp])
  @@index([email])
}

// ====================================================================
// SMS Service Models
// ====================================================================

// SMS Logs for tracking all SMS messages
model SMSLog {
  id             String    @id @default(uuid())
  organizationId String?
  userId         String?
  to             String // Recipient phone number
  from           String // Sender phone number
  message        String // Message content (truncated for privacy)
  messageId      String? // Twilio message SID
  status         String    @default("pending") // pending, sent, delivered, failed, undelivered
  direction      String    @default("outbound") // inbound, outbound
  segments       Int       @default(1) // Number of SMS segments
  cost           Float     @default(0) // Cost in USD
  currency       String    @default("USD")
  countryCode    String? // Destination country code
  errorCode      String? // Twilio error code
  errorMessage   String? // Error description
  deliveredAt    DateTime?
  failedAt       DateTime?
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([messageId])
  @@index([createdAt])
}

// SMS Templates for common messages
model SMSTemplate {
  id             String   @id @default(uuid())
  organizationId String?
  name           String
  type           String // verification_code, password_reset, meeting_reminder, etc.
  content        String // Template content with variables {{var}}
  variables      Json     @default("[]") // List of required variables
  isActive       Boolean  @default(true)
  usageCount     Int      @default(0)
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([type])
  @@index([isActive])
}

// SMS Pricing Cache
model SMSPricing {
  id          String   @id @default(uuid())
  countryCode String   @unique // ISO 3166-1 alpha-2
  countryName String
  mcc         String? // Mobile Country Code
  mnc         String? // Mobile Network Code
  carrierName String?
  pricePerSms Float // Price in USD
  currency    String   @default("USD")
  fetchedAt   DateTime @default(now())
  expiresAt   DateTime // When to refresh the price
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([countryCode])
  @@index([expiresAt])
}

// AI Apps Category Enum
enum AIAppCategory {
  productivity
  sales
  marketing
  analytics
  communication
  documentation
  integration
  healthcare
  legal
  finance
  engineering
  hr
  education
  consulting
  manufacturing
  operations
  research
  strategy
  compliance
  customer_success
}

// AI Apps - Marketplace applications with Claude Opus 4.5 system prompts
model AIApp {
  id              String        @id @default(uuid())
  slug            String        @unique // URL-friendly identifier
  name            String
  description     String // Short description
  longDescription String?       @db.Text // Detailed description
  icon            String // Lucide icon name
  color           String // Tailwind gradient color
  category        AIAppCategory
  tags            String[] // Searchable tags
  rating          Float         @default(4.5)
  downloads       Int           @default(0)
  isPremium       Boolean       @default(false)
  isNew           Boolean       @default(false)
  isTrending      Boolean       @default(false)
  isFeatured      Boolean       @default(false)
  author          String        @default("Nebula AI")
  version         String        @default("1.0.0")
  features        String[] // Feature list
  outputFormats   String[] // Supported output formats
  customizable    Boolean       @default(true)

  // Claude Opus 4.5 System Prompt - The core AI instructions
  systemPrompt String @db.Text

  // Model configuration
  modelId     String @default("claude-opus-4-5-20250514")
  temperature Float  @default(0.7)
  maxTokens   Int    @default(4096)

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Metadata
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usages AIAppUsage[]

  @@index([category])
  @@index([isPremium])
  @@index([isFeatured])
  @@index([rating])
  @@index([downloads])
}

// AI App Usage Tracking
model AIAppUsage {
  id             String   @id @default(uuid())
  aiAppId        String
  aiApp          AIApp    @relation(fields: [aiAppId], references: [id], onDelete: Cascade)
  userId         String
  organizationId String?
  inputTokens    Int      @default(0)
  outputTokens   Int      @default(0)
  duration       Int      @default(0) // Processing time in ms
  success        Boolean  @default(true)
  error          String?
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  @@index([aiAppId])
  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}

// ====================================================================
// SUPER ADMIN DASHBOARD MODELS
// ====================================================================

// Subscription Plans for billing management
model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  description   String?
  features      Json     @default("[]")
  limits        Json     @default("{}")
  pricing       Json     @default("{}")
  stripePriceId String?
  trialDays     Int      @default(14)
  isActive      Boolean  @default(true)
  isPublic      Boolean  @default(true)
  sortOrder     Int      @default(0)
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]

  @@index([isActive])
  @@index([isPublic])
  @@index([sortOrder])
}

// Subscriptions for organizations
model Subscription {
  id                 String           @id @default(uuid())
  organizationId     String           @unique
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId             String
  plan               SubscriptionPlan @relation(fields: [planId], references: [id])
  status             SubStatus        @default(trialing)
  stripeSubId        String?          @unique
  stripeCustomerId   String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean          @default(false)
  cancelledAt        DateTime?
  trialEndsAt        DateTime?
  seats              Int              @default(1)
  metadata           Json             @default("{}")
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([status])
  @@index([planId])
  @@index([stripeSubId])
  @@index([stripeCustomerId])
}

// Alert Rules for monitoring
model AlertRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String
  metric      String
  operator    String
  threshold   Float
  duration    Int      @default(0)
  severity    String   @default("warning")
  channels    Json     @default("[]")
  escalation  Json?
  isEnabled   Boolean  @default(true)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  alerts Alert[]

  @@index([category])
  @@index([isEnabled])
  @@index([severity])
}

// Alerts triggered by rules
model Alert {
  id             String    @id @default(uuid())
  ruleId         String
  rule           AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  status         String    @default("firing")
  firedAt        DateTime  @default(now())
  resolvedAt     DateTime?
  acknowledgedAt DateTime?
  acknowledgedBy String?
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([ruleId])
  @@index([status])
  @@index([firedAt])
}

// Feature Flags for controlled rollouts
model FeatureFlag {
  id           String   @id @default(uuid())
  key          String   @unique
  name         String
  description  String?
  type         String   @default("boolean")
  defaultValue Json     @default("false")
  rules        Json     @default("[]")
  isEnabled    Boolean  @default(true)
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isEnabled])
  @@index([type])
}

// System Settings for platform configuration
model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  category    String
  description String?
  isPublic    Boolean  @default(false)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
}

// ====================================================================
// SUPPORT TICKET SYSTEM MODELS
// ====================================================================

// Support Ticket Status
enum TicketStatus {
  open
  in_progress
  waiting_on_customer
  resolved
  closed
}

// Support Ticket Priority
enum TicketPriority {
  low
  medium
  high
  urgent
}

// Support Tickets for customer support management
model SupportTicket {
  id             String         @id @default(uuid())
  ticketNumber   String         @unique // Human-readable ticket number (e.g., TKT-20231215-0001)
  subject        String
  description    String         @db.Text
  status         TicketStatus   @default(open)
  priority       TicketPriority @default(medium)
  category       String?        // billing, technical, feature_request, bug_report, general
  tags           String[]       @default([])

  // Relations
  organizationId String?
  userId         String // The user who created the ticket
  assigneeId     String? // Admin user assigned to handle the ticket

  // SLA tracking
  firstResponseAt DateTime? // When first response was sent
  resolvedAt      DateTime? // When ticket was resolved
  closedAt        DateTime? // When ticket was closed
  slaBreached     Boolean   @default(false)

  // Escalation tracking
  escalationLevel Int       @default(0) // 0 = normal, 1 = escalated, 2 = critical escalation
  escalatedAt     DateTime?
  escalatedBy     String?

  // Satisfaction
  satisfactionRating Int? // 1-5 rating
  satisfactionComment String?

  // Metadata
  source         String    @default("web") // web, email, api, phone
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  messages TicketMessage[]

  @@index([status])
  @@index([priority])
  @@index([organizationId])
  @@index([userId])
  @@index([assigneeId])
  @@index([ticketNumber])
  @@index([createdAt])
  @@index([status, priority])
  @@index([assigneeId, status])
  @@index([organizationId, status])
}

// Ticket Messages - conversation history for support tickets
model TicketMessage {
  id         String        @id @default(uuid())
  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId   String // User ID of the sender
  senderType String        @default("user") // user, admin, system
  senderName String? // Display name of sender
  content    String        @db.Text
  isInternal Boolean       @default(false) // Internal notes visible only to admins

  // Attachments
  attachments Json @default("[]") // Array of {name, url, size, mimeType}

  // Metadata
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isInternal])
}

// ====================================================================
// COMPLIANCE & SECURITY MODELS
// ====================================================================

// GDPR Request Types
enum GdprRequestType {
  export // Data export request (Article 15 - Right of access)
  delete // Data deletion request (Article 17 - Right to erasure)
}

// GDPR Request Status
enum GdprRequestStatus {
  pending    // Request received, not started
  processing // Request is being processed
  completed  // Request fulfilled
  failed     // Request failed
  cancelled  // Request cancelled by user or admin
}

// GDPR Data Requests
model GdprRequest {
  id              String            @id @default(uuid())
  type            GdprRequestType
  userId          String // User whose data is being requested
  status          GdprRequestStatus @default(pending)
  requestedAt     DateTime          @default(now())
  startedAt       DateTime? // When processing started
  completedAt     DateTime? // When request was fulfilled
  requestedBy     String // Admin who initiated the request
  processedBy     String? // Admin who processed the request

  // For export requests
  exportFileUrl   String? // S3 URL for exported data
  exportFileSize  BigInt? // Size of export file in bytes
  exportExpiresAt DateTime? // When export link expires

  // For delete requests
  deletedTables   Json @default("[]") // Tables from which data was deleted
  deletedCount    Int  @default(0) // Total records deleted

  // Notes and audit
  notes        String? @db.Text // Admin notes
  errorMessage String? // Error details if failed
  auditTrail   Json    @default("[]") // Detailed audit trail of actions

  // Metadata
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([requestedAt])
  @@index([requestedBy])
}

// Platform Security Settings (singleton - use key 'default')
model SecuritySettings {
  id  String @id @default(uuid())
  key String @unique @default("default")

  // Password Policy
  passwordMinLength        Int     @default(12)
  passwordMaxLength        Int     @default(128)
  passwordRequireUppercase Boolean @default(true)
  passwordRequireLowercase Boolean @default(true)
  passwordRequireNumbers   Boolean @default(true)
  passwordRequireSpecial   Boolean @default(true)
  passwordExpiryDays       Int     @default(90) // 0 = never expires
  passwordHistoryCount     Int     @default(5) // Prevent reuse of last N passwords

  // MFA Settings
  mfaRequired          Boolean @default(false) // Require MFA for all users
  mfaRequiredForAdmins Boolean @default(true) // Require MFA for admin roles
  mfaAllowedMethods    Json    @default("[\"totp\", \"webauthn\"]") // Allowed MFA methods

  // Session Settings
  sessionTimeoutMinutes     Int @default(60) // Session timeout in minutes
  maxConcurrentSessions     Int @default(5) // Max concurrent sessions per user
  sessionIdleTimeoutMinutes Int @default(30) // Idle timeout before re-auth

  // Login Security
  maxLoginAttempts          Int     @default(5) // Before lockout
  lockoutDurationMinutes    Int     @default(30) // Lockout duration
  loginNotificationsEnabled Boolean @default(true) // Email on new login

  // IP Whitelist (stored as JSON array of IP addresses/CIDR ranges)
  ipWhitelistEnabled Boolean @default(false)
  ipWhitelist        Json    @default("[]") // Array of {ip, label, addedBy, addedAt}

  // API Security
  apiKeyExpiryDays      Int @default(365) // API key expiry
  apiRateLimitPerMinute Int @default(1000) // Default rate limit

  // Audit Settings
  auditRetentionDays Int @default(365) // How long to keep audit logs

  // Last updated tracking
  updatedBy String? // Admin who last updated
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// IP Whitelist Entries (separate table for better querying)
model IpWhitelistEntry {
  id         String    @id @default(uuid())
  ip         String    @unique // IP address or CIDR range
  label      String? // Description/label for the IP
  addedBy    String // Admin who added this entry
  isActive   Boolean   @default(true)
  expiresAt  DateTime? // Optional expiry date
  lastUsedAt DateTime? // Last time this IP was used
  useCount   Int       @default(0) // Number of times this IP was used
  metadata   Json      @default("{}")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([ip])
  @@index([isActive])
  @@index([addedBy])
}

// Security Threat Detection
model SecurityThreat {
  id             String @id @default(uuid())
  type           String // brute_force, suspicious_ip, unusual_activity, etc.
  severity       String @default("medium") // low, medium, high, critical
  status         String @default("active") // active, investigating, resolved, false_positive

  // Threat Details
  ipAddress      String?
  userId         String?
  userEmail      String?
  organizationId String?
  description    String  @db.Text
  evidence       Json    @default("{}") // Raw evidence data

  // Detection
  detectedAt DateTime @default(now())
  detectedBy String   @default("system") // system or admin ID

  // Resolution
  resolvedAt   DateTime?
  resolvedBy   String?
  resolution   String?   @db.Text // How it was resolved
  actionsTaken Json      @default("[]") // Actions taken (blocked, notified, etc.)

  // Metadata
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([ipAddress])
  @@index([userId])
  @@index([detectedAt])
}
